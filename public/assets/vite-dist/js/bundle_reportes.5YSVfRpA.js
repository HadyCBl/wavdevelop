import{S as e}from"./chunk_vendors.BgDCcFUb.js";import"./chunk_jquery.Cg98Jr1F.js";class t{constructor(e="/api/reportes"){this.baseURL=e}async request(t,r={}){const a=`${this.baseURL}${t}`,o={headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"};try{const t=await fetch(a,{...o,...r}),i=await t.json();if("expired"===i.messagecontrol)throw await e.fire({icon:"error",title:"Sesión Expirada",text:i.mensaje}),setTimeout((()=>{window.location.href=i.url}),2e3),new Error("Sesión expirada");return i}catch(i){throw i}}async listarReportes(){return this.request("",{method:"GET"})}async generarReporte(e,t){const r="/"+e.replace(/_/g,"-");return this.request(r,{method:"POST",body:JSON.stringify(t)})}}const r=new class{constructor(){this.api=new t,this.loader=null}toggleLoader(e){if("function"==typeof loaderefect)loaderefect(e?1:0);else{const t=document.querySelector(".loader-container");t&&t.classList.toggle("loading--show",e)}}getFormData(e){const t=document.querySelector(e);if(!t)throw new Error(`Contenedor ${e} no encontrado`);const r={};if("FORM"===t.tagName){const e=new FormData(t);for(let[t,a]of e.entries())r[t]=a}else{t.querySelectorAll("input, select, textarea").forEach((e=>{const t=e.name||e.id;t&&("checkbox"===e.type?r[t]=e.checked:"radio"===e.type?e.checked&&(r[t]=e.value):r[t]=e.value)}))}return r}validateForm(e){const t=document.querySelector(e);if(!t)return{esValido:!1,errores:[`Contenedor ${e} no encontrado`]};const r=[],a=[],o=new Set;return t.querySelectorAll("input[required], select[required], textarea[required]").forEach((e=>{"radio"===e.type?o.add(e.name):"SELECT"===e.tagName?a.push(e.id):r.push(e.id)})),"function"==typeof window.validarCamposGeneric?window.validarCamposGeneric(r,a,Array.from(o)):{esValido:!1,errores:["Error de validación: función no disponible"]}}async generarReporte(t,r,a={}){try{this.toggleLoader(!0);const o=this.validateForm(r);if(!o.esValido)return this.toggleLoader(!1),void(await e.fire({icon:"warning",title:"Validación de Campos",html:o.errores.join("<br>"),confirmButtonText:"Entendido"}));const i={...this.getFormData(r),tipo:a.tipo||"pdf"},s=await this.api.generarReporte(t,i);1===s.status?await this.procesarRespuesta(s,a):(this.toggleLoader(!1),await e.fire({icon:"error",title:s.error||"Error",text:s.mensaje||s.message||"Error al generar reporte"}))}catch(o){this.toggleLoader(!1),await e.fire({icon:"error",title:"Error",text:"Ocurrió un error al generar el reporte"})}finally{this.toggleLoader(!1)}}async generarReporteDirect(t,r={},a={}){const o=!1!==a.showLoader;try{o&&this.toggleLoader(!0);const i={...r,tipo:a.tipo||"pdf"},s=await this.api.generarReporte(t,i);if(1===s.status)return await this.procesarRespuesta(s,a),a.onSuccess&&"function"==typeof a.onSuccess&&a.onSuccess(s),s;{o&&this.toggleLoader(!1);const t=s.mensaje||s.message||"Error al generar reporte";throw await e.fire({icon:"error",title:s.error||"Error",text:t}),a.onError&&"function"==typeof a.onError&&a.onError(s),new Error(t)}}catch(i){throw o&&this.toggleLoader(!1),i.message&&i.message.includes("Error al generar")||await e.fire({icon:"error",title:"Error",text:i.message||"Ocurrió un error al generar el reporte"}),a.onError&&"function"==typeof a.onError&&a.onError(i),i}finally{o&&this.toggleLoader(!1)}}async procesarRespuesta(t,r){switch(r.tipo||"json"){case"xlsx":case"pdf":this.descargarArchivo(t.data,t.namefile,t.tipo),this.toggleLoader(!1),await e.fire({icon:"success",title:"Reporte Generado",text:"El archivo se ha descargado correctamente"});break;case"show":this.toggleLoader(!1);const a=this.base64ToBlob(t.data,"application/pdf"),o=URL.createObjectURL(a);window.open(o,"_blank");break;default:if(this.toggleLoader(!1),r.onSuccess&&"function"==typeof r.onSuccess)r.onSuccess(t);else if(r.mostrarTabla||r.mostrarGrafica){const a=t.datos||t.data||[];if(a&&a.length>0){if(r.mostrarTabla&&r.configTabla&&this.actualizarTabla(a,r.configTabla.encabezados,r.configTabla.keys,r.configTabla.selector||"#tbdatashow"),r.mostrarGrafica&&r.configGrafica){let e=a;r.configGrafica.dataKey&&t[r.configGrafica.dataKey]&&(e=t[r.configGrafica.dataKey]),r.configGrafica.datasets?this.crearGraficaAvanzada(e,r.configGrafica):this.actualizarGrafica(e,r.configGrafica.titulo,r.configGrafica.topDown||1,r.configGrafica.selector||"#myChart")}await e.fire({icon:"success",title:"Reporte Generado",text:`Se procesaron ${a.length} registros`,timer:2e3,showConfirmButton:!1})}else await e.fire({icon:"info",title:"Sin Datos",text:"No se encontraron registros para los filtros seleccionados"})}else await e.fire({icon:"success",title:"Reporte Generado",text:`Se obtuvieron ${t.datos?.length||0} registros`})}}descargarArchivo(e,t,r){const a=this.base64ToBlob(e,{xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",pdf:"application/pdf"}[r]),o=URL.createObjectURL(a),i=document.createElement("a");i.href=o,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}base64ToBlob(e,t=""){let r=e;e.includes(",")&&(r=e.split(",")[1]);const a=atob(r),o=[];for(let i=0;i<a.length;i+=512){const e=a.slice(i,i+512),t=new Array(e.length);for(let a=0;a<e.length;a++)t[a]=e.charCodeAt(a);const r=new Uint8Array(t);o.push(r)}return new Blob(o,{type:t})}actualizarTabla(e,t,r,a="#tbdatashow"){const o=$(a);if(!o.length)return;$("#divshow").show(),o.find("thead").empty();const i=$("<tr></tr>");t.forEach((e=>{i.append(`<th class="text-center">${e}</th>`)})),o.find("thead").append(i);let s=o.DataTable();s&&s.destroy(),s=o.DataTable({data:e.map((e=>r.map((t=>e[t])))),columns:r.map((()=>({className:"text-center"})))})}actualizarGrafica(e,t,r=1,a="#myChart"){$("#divshowchart").show();const o=1==r?e.slice(0,30):e.slice(-30),i=o.map((e=>e.fecha)),s=o.map((e=>e.cantidad)),n=document.querySelector(a);n&&(window.myChart&&window.myChart.destroy(),window.myChart=new Chart(n,{type:"bar",data:{labels:i,datasets:[{label:t,data:s,backgroundColor:"#1E90FF",borderColor:"#87CEEB",borderWidth:4}]},options:{responsive:!0,plugins:{legend:{display:!0},datalabels:{anchor:"end",align:"top",formatter:Math.round,font:{size:12}}},scales:{y:{beginAtZero:!0}}}}))}crearGraficaAvanzada(e,t){const r=document.querySelector(t.selector||"#myChart");if(!r)return;this.chart&&this.chart.destroy(),$("#divshowchart").show();const a=r.getContext("2d"),o=e.map((e=>e[t.labels])),i=t.datasets.map((t=>({label:t.label,data:e.map((e=>e[t.key])),backgroundColor:t.color,borderColor:t.color,borderWidth:1})));this.chart=new Chart(a,{type:t.type||"bar",data:{labels:o,datasets:i},options:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!0,text:t.titulo||"Gráfica"}},scales:{y:{beginAtZero:!0}}}})}};"undefined"!=typeof window&&(window.reporteManager=r);
